## Default values for piggy-webhooks.
## This is a YAML-formatted file.
## Declare variables to be passed into your templates.

## Number of replicas for the piggy-webhooks deployment.
replicaCount: 1

image:
  ## Image repository for piggy-webhooks.
  repository: ghcr.io/kongz/piggy-webhooks
  ## Image pull policy.
  pullPolicy: IfNotPresent
  ## Overrides the image tag whose default is the chart appVersion.
  tag: "0.7.0"

## List of image pull secrets for the deployment.
imagePullSecrets: []
## Name override for the resources.
nameOverride: ""
## Full name override for the resources.
fullnameOverride: ""

## Internal port the piggy-webhooks container listens on.
port: 8443

serviceAccount:
  ## Specifies whether a service account should be created.
  create: true
  ## Annotations to add to the service account.
  annotations: {}
  ## The name of the service account to use.
  ## If not set and create is true, a name is generated using the fullname template.
  name: ""

## Annotations to add to the pods.
podAnnotations: {}

## Pod security context for the piggy-webhooks pods.
podSecurityContext:
  runAsUser: 10001
  fsGroup: 65534

## Security context for the piggy-webhooks container.
securityContext:
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 10001
  runAsGroup: 65534
  allowPrivilegeEscalation: false
  seccompProfile:
    type: RuntimeDefault

service:
  ## Service type (ClusterIP, NodePort, LoadBalancer).
  type: ClusterIP
  ## Service port.
  port: 443

ingress:
  ## Enable ingress for the webhook service (usually not needed as it's called internally).
  enabled: false
  ## Ingress class name.
  className: ""
  ## Ingress annotations.
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  ## Ingress host.
  host: piggy-webhooks.local
  ## Ingress path.
  path: /
  ## Ingress path type.
  pathType: ImplementationSpecific

## Resource limits and requests for the piggy-webhooks container.
resources:
  limits:
    cpu: 200m
    memory: 128Mi
  requests:
    cpu: 200m
    memory: 128Mi

autoscaling:
  ## Enable Horizontal Pod Autoscaler.
  enabled: false
  ## Minimum number of replicas.
  minReplicas: 1
  ## Maximum number of replicas.
  maxReplicas: 100
  ## Target CPU utilization percentage.
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

## Set number of pods from that can be unavailable after the eviction.
## It can be either an absolute number or a percentage.
maxUnavailable: 1

## Specify the PriorityClass name for piggy.
## Default value is set to system-cluster-critical to ensure that piggy is always schedule first.
priorityClassName: system-cluster-critical

## Node selector for pod assignment.
nodeSelector: {}

## Tolerations for pod assignment.
tolerations: []

## Affinity settings for pod assignment.
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: piggy-webhooks
          topologyKey: kubernetes.io/hostname

## Additional volume mounts for the piggy-webhooks container.
volumeMounts: []

## Additional volumes for the piggy-webhooks pod.
volumes: []

rbac:
  psp:
    ## Enable PodSecurityPolicy (deprecated in K8s 1.25+).
    enabled: false

aws:
  ## Specify the Role ARN for IRSA (IAM Roles for Service Accounts).
  ## This is required for piggy-webhooks to access AWS Secrets Manager or Parameter Store.
  roleArn:

## Additional environment variables for piggy-webhooks.
env: {}
  ## Set default AWS region for all secret manager.
  # AWS_REGION: "ap-southeast-1"
  ## Force to check `PIGGY_ALLOWED_SA` env value in AWS secret manager.
  # PIGGY_ENFORCE_SERVICE_ACCOUNT: "true"
  ## Set default secret name prefix. If set the default secret name will be `${prefix}${namespace}/${sa}`.
  # PIGGY_DEFAULT_SECRET_NAME_PREFIX: ""
  ## Set default secret name suffix. If set the default secret name will be `${namespace}/${sa}${suffix}`.
  # PIGGY_DEFAULT_SECRET_NAME_SUFFIX: ""
  ## Set delay piggy to run in seconds. This is useful when using Istio Envoy. The Envoy took 2 seconds to operate before allowing any
  ## traffic outgoing from Pod.
  # PIGGY_DELAY_SECOND: "2"
  ## Set number of retry for retrieving secret. This is useful when using Istio Envoy. Each retryment will sleep for 500ms.
  ## Set to 4-6 is a good number if you are using Envoy on sidecar.
  # PIGGY_NUMBER_OF_RETRY: "6"
  ## Set a variable to `true` for not exiting if no environment variable found on AWS secret manager.
  # PIGGY_IGNORE_NO_ENV: "false"

mutate:
  certificate:
    certManager:
      ## Use cert-manager to manage the webhook certificate.
      enabled: false
      privateKey:
        algorithm: ECDSA
        size: 256
    ## Automatically generate a self-signed certificate if cert-manager is not used.
    generate: true
    ## Set the certificate validity in days (applies to both cert-manager and self-generated).
    certValidity: 3650
    tls:
      ## Custom TLS certificate (base64 encoded). Required if generate is false.
      crt:
      ## Custom TLS private key (base64 encoded). Required if generate is false.
      key:
    ca:
      ## Custom CA certificate (base64 encoded). Required if generate is false.
      crt:
  ## Timeout for the webhook call in seconds.
  timeoutSeconds: false
  ## How unrecognized errors and timeout errors from the admission webhook are handled.
  ## Fail: The admission request is rejected. This can prevent Pods from starting if piggy-webhooks itself is down.
  ## Ignore: The admission request is accepted. This can allow Pods to start even if piggy-webhooks itself is down.
  ## See https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#failure-policy
  podsFailurePolicy: Fail
  image:
    ## Image repository for the piggy-env init-container.
    repository: ghcr.io/kongz/piggy-env
    ## Image pull policy for piggy-env.
    pullPolicy: IfNotPresent
    ## Image tag for piggy-env.
    tag: "0.7.0"
  ## If the pods being admitted is modified by other admission plugins after the initial webhook call,
  ## set this value to 'IfNeeded' to allow the webhook to be called again. Set to 'Never' to prevent the webhook from being called again.
  reinvocationPolicy: IfNeeded
  ## List of namespaces to exclude from the webhook mutation.
  excludeNamespaces: []
  ## Object selector for the webhook. Allows filtering pods by labels.
  objectSelector: {}
  ## Match conditions for the webhook (Kubernetes v1.27+ only).
  ## Uses CEL (Common Expression Language) to filter pods by annotations at the API server level.
  matchConditions:
    - name: "include-piggy-pods"
      expression: |
        has(object.metadata.annotations) && (
          'piggysec.com/piggy-address' in object.metadata.annotations ||
          'piggysec.com/aws-secret-name' in object.metadata.annotations ||
          'piggysec.com/aws-ssm-parameter-path' in object.metadata.annotations
        )

## Set to true to enable debug mode for piggy-webhooks.
debug: false
